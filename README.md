# StudyBuddy 学习伙伴

基于 AI 视觉的智能学习陪伴系统，通过摄像头实时分析孩子的学习状态，并通过 Web 界面提供友好的规则配置和监控管理。

## ✨ 主要功能

- 🎯 **智能分析**: 使用 Kimi Vision API 分析学习状态
- 📸 **实时监控**: 自动捕获学习场景照片
- 💬 **智能通知**: 支持企业微信多收件人通知
- 🖥️ **Web 管理**: 可视化配置规则和监控界面
- ⚙️ **灵活规则**: Web 页面自定义提醒规则（正则表达式）
- 📊 **历史记录**: 完整的学习状态历史，不合格红色标记
- ⏰ **定时任务**: 每天自动启动和停止监控
- 🎥 **摄像头调试**: 实时查看摄像头画面

## 📁 项目结构

```
study-buddy/
├── core/                   # 核心模块
│   ├── __init__.py
│   ├── base.py            # 基础类定义
│   ├── config.py          # 环境变量管理（API keys）
│   └── scheduler.py       # 调度中心
├── modules/               # 功能模块
│   ├── vision/            # 视觉模块
│   │   └── __init__.py    # Camera + KimiVisionAnalyzer
│   └── im/                # 通知模块
│       └── __init__.py    # WeChatNotifier + IMManager
├── data/                  # 运行时数据
│   ├── captures/          # 捕获的图片
│   └── monitor_config.json # Web 保存的规则配置
├── logs/                  # 日志目录
├── main.py                # 命令行入口
├── web_server.py          # Web 管理界面
├── requirements.txt       # Python 依赖
├── .env.example           # 配置文件示例
└── .gitignore             # Git 忽略规则
```

## 🚀 快速开始

### 1. 安装依赖

```bash
cd study-buddy
pip install -r requirements.txt
```

### 2. 配置环境变量

复制配置文件并编辑：

```bash
cp .env.example .env
```

编辑 `.env` 文件，填入必要的配置信息：

```env
# Kimi Vision API（必需）
KIMI_API_KEY=your_kimi_api_key_here
KIMI_BASE_URL=https://api.moonshot.cn/v1
KIMI_MODEL=moonshot-v1-8k-vision-preview
KIMI_TIMEOUT=120

# 企业微信配置（可选，不配置则不发送通知）
WECHAT_CORPID=your_corp_id
WECHAT_AGENTID=your_agent_id
WECHAT_SECRET=your_app_secret
WECHAT_TOUSER=user1|user2    # 多个用户用 | 分隔

# 摄像头配置
CAMERA_INDEX=0              # 摄像头索引，默认0
RESOLUTION=1920,1080        # 分辨率
IMAGE_QUALITY=85            # 图片质量
```

### 3. 启动 Web 管理界面（推荐使用）

```bash
python web_server.py
```

访问：**http://localhost:5000**

## 💡 使用指南

### Web 界面功能

访问 **http://localhost:5000** 后，你可以：

#### 1️⃣ 监控控制页面

- **启动监控**: 开始自动截图和AI分析
- **停止监控**: 停止监控任务
- **查看历史**: 浏览所有历史截图，不合格的会显示红色背景
- **实时状态**: 查看当前监控状态、运行时间、截图次数等

#### 2️⃣ 规则配置

在"提醒规则配置"卡片中，使用正则表达式定义孩子应该达到的学习状态：

```
在书桌前: ^是$              # 必须在书桌前
正在玩耍: ^否$              # 不能玩耍
当前活动: ^(看书|写字)$      # 只能看书或写字
坐姿状态: ^端正$            # 坐姿必须端正
台灯状态: ^是$              # 必须开台灯
照明情况: ^(充足|一般)$     # 不能昏暗
```

**规则说明**：
- 格式：`字段名: 正则表达式`
- 如果AI返回的内容匹配正则表达式，则认为该项合格
- 只要有一项不合格，就会立即发送通知（包含图片）
- 所有字段都合格时，不会发送通知（除非超过了通知间隔）

#### 3️⃣ 时间间隔配置

- **截图间隔**: 多久截图一次（默认30秒）
- **通知间隔**: 即使状态合格，也会定期发送状态更新（默认5分钟）
- **停止间隔**: 连续不合格多久后自动停止监控（默认1小时）

#### 4️⃣ 定时任务（NEW！）

在"定时任务配置"卡片中：

- **启用定时任务**: 勾选后启用
- **开始时间**: 每天自动启动监控的时间（如 08:00）
- **结束时间**: 每天自动停止监控的时间（如 18:00）

**使用场景**：
家长可以在早上出门前设置好时间，系统会自动在指定时间启动和停止监控，无需手动操作。

**注意事项**：
- 定时任务每天只执行一次
- 到达开始时间后会自动启动监控
- 到达结束时间后会自动停止监控
- 手动启动/停止不会影响定时任务

#### 5️⃣ 摄像头调试

点击导航栏的"摄像头调试"可以：
- 实时查看摄像头画面（MJPEG流）
- 测试摄像头是否正常工作
- 调整摄像头位置和角度

访问：**http://localhost:5000/camera**

#### 6️⃣ 保存配置

- 所有配置修改后，点击页面底部的"💾 保存配置"按钮
- 只有配置被修改时，保存按钮才会可用
- 保存后配置立即生效

### 命令行运行（可选）

如果不使用 Web 界面，可以直接运行：

```bash
python main.py
```

使用 `.env` 中的配置运行。

## 🎯 核心功能

### AI 视觉分析

Kimi Vision API 自动分析以下维度：
- ✅ 在书桌前检测
- ✅ 玩耍行为识别
- ✅ 当前活动识别（看书/写字/用电脑/玩手机/发呆）
- ✅ 坐姿状态检测（端正/不佳/趴着/歪坐）
- ✅ 台灯状态检测
- ✅ 照明情况分析

### 智能提醒机制

系统会自动：
1. **规则检查**: 对比AI分析结果与配置的规则
2. **立即通知**: 发现不合格立即发送通知（包含截图）
3. **定期汇报**: 即使合格，也会定期发送状态更新
4. **自动停止**: 连续不合格太久自动停止监控

### 多收件人通知

支持同时向多个企业微信用户发送通知：

```env
WECHAT_TOUSER=RenYuan|xiaoyu
```

用 `|` 分隔多个用户名。

## 📝 配置文件说明

### `.env` - 环境变量（需手动配置）

存放 **敏感信息**，不要提交到 Git：
- Kimi API 密钥（必需）
- 企业微信凭证（可选）
- 摄像头索引

### `data/monitor_config.json` - Web配置（自动生成）

Web 页面保存的配置：
- 提醒规则（正则表达式）
- 时间间隔
- 定时任务设置

**此文件会被 .gitignore 忽略**

## 🔧 技术栈

- **Python 3.8+**
- **OpenCV**: 摄像头捕获
- **Kimi Vision API**: AI 图像分析
- **Flask**: Web 管理界面
- **企业微信 API**: 消息通知

## 📋 常见问题

### Q1: 摄像头无法打开？

**A**: 检查以下几点：
1. 摄像头是否被其他程序占用
2. `.env` 中的 `CAMERA_INDEX` 是否正确（尝试 0, 1, 2...）
3. 访问 `/camera` 页面测试摄像头是否正常

### Q2: 收不到企业微信通知？

**A**: 确认：
1. `.env` 中的企业微信配置是否正确
2. `WECHAT_TOUSER` 中的用户名是否正确
3. 网络是否正常（可以访问企业微信API）

### Q3: 定时任务没有自动启动？

**A**:
1. 确认"启用定时任务"已勾选并保存
2. 检查当前时间是否在开始时间和结束时间之间
3. 查看服务器控制台是否有"[调度器]"相关日志

### Q4: AI 分析一直失败？

**A**:
1. 检查 `.env` 中的 `KIMI_API_KEY` 是否正确
2. 确认网络可以访问 Kimi API
3. 查看控制台日志了解具体错误信息

## 🔒 隐私说明

- 所有截图保存在 `data/captures/` 目录
- 历史记录仅在本地保存，不会上传到云端
- `.env` 文件包含敏感信息，**不要提交到 Git**
- 企业微信通知包含图片，请确保收件人可信赖

## 📞 支持

如有问题或建议，请提交 Issue 或 Pull Request。

